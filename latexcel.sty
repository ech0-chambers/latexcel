\ProvidesPackage{latexcel}[2023/12/04 v1.0 Excel and Google Sheets style rendering for LaTeX]


\newcommand*\makealph[1]{\symbol{\numexpr96+#1}}
\newcommand*\makeAlph[1]{\symbol{\numexpr64+#1}}


\RequirePackage{tikz}


\usetikzlibrary{calc, positioning}
\RequirePackage{xcolor}

%
\definecolor{gridlinecolor}{HTML}{dfdfdf}%
\definecolor{cornercolor}{HTML}{F8F9FA}%
\definecolor{cornerbordercolor}{HTML}{C7C7C7}%
\definecolor{labelbordercolor}{HTML}{C4C7C5}%
\definecolor{labeltextcolor}{HTML}{444746}%
\definecolor{selectedbordercolor}{HTML}{0A57D0}%
\definecolor{selectedcelldotcolor}{HTML}{0A57D0}%
\definecolor{formulabarbordercolor}{HTML}{F9FBFD}%
\definecolor{selectedcelldropdowncolor}{HTML}{444746}%
\definecolor{fxcolor}{HTML}{A5A7A6}%
\definecolor{selectedcolumncolor}{HTML}{D3E3FD}%

\RequirePackage{environ}

\newcommand{\fillcell}[3]{
    % fill a cell with a color
    \begin{pgfonlayer}{cells}
        \setint{\nextcellx}{#1-1}
        \setint{\nextcelly}{#2-1}
        \fill[#3] (corner_\nextcellx_\nextcelly) rectangle (corner_#1_#2);
    \end{pgfonlayer}
}

\newcommand{\cellcontents}[4][]{
    % write contents to a cell
    \node[#1] at (cell_#2_#3) {#4};
}

\ExplSyntaxOn

\newcommand\setint[2]{
    \def#1{\fp_to_int:n{#2}}
}

\newcommand\round[2][0]{
    \fp_eval:n{round(#2,#1)}
}

\keys_define:nn {latexcel} {
    row~height .fp_set:N = \l_latexcel_row_height_fp,
    row~height .initial:n = 1,
    padding~rows .int_set:N = \l_latexcel_padding_rows_int,
    padding~rows .initial:n = 1,
    padding~row~height .fp_set:N = \l_latexcel_padding_row_height_fp,
    padding~row~height .initial:n = 0.65,
    starting~row .int_set:N = \l_latexcel_starting_row_int,
    starting~row .initial:n = 2,
    column~width .fp_set:N = \l_latexcel_column_width_fp,
    column~width .initial:n = 4,
    padding~columns .int_set:N = \l_latexcel_padding_columns_int,
    padding~columns .initial:n = 1,
    padding~column~width .fp_set:N = \l_latexcel_padding_column_width_fp,
    padding~column~width .initial:n = 0.65,
    starting~column .int_set:N = \l_latexcel_starting_column_int,
    starting~column .initial:n = 2,
    header~row~color .tl_set:N = \l_latexcel_header_row_color_tl,
    header~row~color .initial:n = {white},
    header~cell~style .tl_set:N = \l_latexcel_header_cell_styles_tl,
    header~cell~style .initial:n = {},
    every~header~cell~style .tl_set:N = \l_latexcel_every_header_cell_style_tl,
    every~header~cell~style .initial:n = {},
    even~row~color .tl_set:N = \l_latexcel_even_row_color_tl,
    even~row~color .initial:n = {white},
    odd~row~color .tl_set:N = \l_latexcel_odd_row_color_tl,
    odd~row~color .initial:n = {white},
    cell~style .tl_set:N = \l_latexcel_cell_styles_tl,
    cell~style .initial:n = {},
    every~cell~style .tl_set:N = \l_latexcel_every_cell_style_tl,
    every~cell~style .initial:n = {},
    borders .bool_set:N = \l_latexcel_border_bool,
    borders .initial:n = true,
    borders .default:n = true,
    border~style .tl_set:N = \l_latexcel_border_style_tl,
    border~style .initial:n = {black},
    border~width .dim_set:N = \l_latexcel_border_width_dim,
    border~width .initial:n = 0.75pt,
    row~borders .bool_set:N = \l_latexcel_row_borders_bool,
    row~borders .initial:n = false,
    row~borders .default:n = true,
    column~borders .bool_set:N = \l_latexcel_column_borders_bool,
    column~borders .initial:n = true,
    column~borders .default:n = true,
    selected~cell .tl_set:N = \l_latexcel_selected_cell_tl,
    selected~cell .initial:n = {},
    formula .tl_set:N = \l_latexcel_formula_tl,
    formula .initial:n = {},
    auto~formula .bool_set:N = \l_latexcel_auto_formula_bool,
    auto~formula .initial:n = true,
    auto~formula .default:n = true,
    show~formula~bar .bool_set:N = \l_latexcel_show_formula_bar_bool,
    show~formula~bar .initial:n = true,
    scale .fp_set:N = \l_latexcel_scale_fp,
    scale .initial:n = 1,
}

\newcommand{\latexcelset}[1]{
    \keys_set:nn {latexcel} {#1}
}

\seq_new:N \l_latexcel_rows_seq
\seq_new:N \l_latexcel_cells_seq

\seq_new:N \g_latexcel_cell_styles_seq
\int_new:N \g_latexcel_num_styles_int
\seq_new:N \g_latexcel_header_styles_seq
\int_new:N \g_latexcel_num_header_styles_int
\tl_new:N  \l_latexcel_cell_style_tl

\int_new:N \l_latexcel_num_columns_int
\int_new:N \l_latexcel_num_rows_int

\seq_new:N \l_latexcel_header_row_seq

\bool_new:N \l_latexcel_formula_is_blank_bool

\NewEnviron{latexcel}[1][]{
    \group_begin:
        \pgfdeclarelayer{gridlines}
        \pgfdeclarelayer{borders}
        \pgfdeclarelayer{cells}

        \pgfsetlayers{cells, main, gridlines, borders}
        \keys_set:nn {latexcel} {#1}
        \seq_set_split:NnV \l_latexcel_rows_seq {\\} {\BODY}
        \int_set:Nn \l_latexcel_num_rows_int {\seq_count:N \l_latexcel_rows_seq}
        \seq_get_left:NN \l_latexcel_rows_seq \l_tmpa_tl
        \seq_set_split:NnV \l_tmpb_seq {&} {\l_tmpa_tl}
        \int_set:Nn \l_latexcel_num_columns_int {\seq_count:N \l_tmpb_seq}

        % Prepare the cell styles, which may be different for each column
        \seq_set_split:NnV \l_tmpa_seq {,} {\l_latexcel_cell_styles_tl}
        \int_gset:Nn \g_latexcel_num_styles_int {\seq_count:N \l_tmpa_seq}
        % Set the sequence to the styles in order, repeating if necessary
        \seq_gclear:N \g_latexcel_cell_styles_seq
        \int_step_inline:nnn {1} {\l_latexcel_num_columns_int} {
            \int_set:Nn \l_tmpa_int {\int_mod:nn {##1-1} {\g_latexcel_num_styles_int}+1}
            \seq_gput_right:Nx \g_latexcel_cell_styles_seq {\seq_item:Nn \l_tmpa_seq {\l_tmpa_int}}
        }

        % Do the same for the header row
        \seq_set_split:NnV \l_tmpa_seq {,} {\l_latexcel_header_cell_styles_tl}
        \int_gset:Nn \g_latexcel_num_header_styles_int {\seq_count:N \l_tmpa_seq}
        % Set the sequence to the styles in order, repeating if necessary
        \seq_gclear:N \g_latexcel_header_styles_seq
        \int_step_inline:nnn {1} {\l_latexcel_num_columns_int} {
            \int_set:Nn \l_tmpa_int {\int_mod:nn {##1-1} {\g_latexcel_num_header_styles_int}+1}
            \seq_gput_right:Nx \g_latexcel_header_styles_seq {\seq_item:Nn \l_tmpa_seq {\l_tmpa_int}}
        }
        
        \tl_if_empty:NTF \l_latexcel_formula_tl {
            \bool_set_true:N \l_latexcel_formula_is_blank_bool
        } {
            \bool_set_false:N \l_latexcel_formula_is_blank_bool
        }

        \pgfmathsetmacro{\latexcel@numrows}{\fp_to_int:n{\l_latexcel_num_rows_int}}
        \pgfmathsetmacro{\latexcel@numcolumns}{\fp_to_int:n{\l_latexcel_num_columns_int}}
        \pgfmathsetmacro{\latexcel@cellwidth}{\fp_to_decimal:n{\l_latexcel_column_width_fp}}%
        \pgfmathsetmacro{\latexcel@cellheight}{\fp_to_decimal:n{\l_latexcel_row_height_fp}}%
        \pgfmathsetmacro{\latexcel@columnlabelheight}{0.55}%
        \pgfmathsetmacro{\latexcel@rowlabelwidth}{1.2}%
        \pgfmathsetmacro{\latexcel@paddingrowheight}{\fp_to_decimal:n{\l_latexcel_padding_row_height_fp}}%
        \pgfmathsetmacro{\latexcel@paddingrows}{\int_use:N \l_latexcel_padding_rows_int}%
        \pgfmathsetmacro{\latexcel@paddingcolumnwidth}{\fp_to_decimal:n{\l_latexcel_padding_column_width_fp}}%
        \pgfmathsetmacro{\latexcel@paddingcolumns}{\int_use:N \l_latexcel_padding_columns_int}%
        \pgfmathsetmacro{\latexcel@startingcolumn}{\l_latexcel_starting_column_int}%
        \pgfmathsetmacro{\latexcel@startingrow}{\int_use:N \l_latexcel_starting_row_int}%
        \pgfmathsetmacro{\latexcel@formulabarheight}{0.75}%
        \pgfmathsetmacro{\latexcel@selectedcellwidth}{2.75}%
        \setint{\latexcel@firstpaddingrow}{\latexcel@numrows+1}%
        \setint{\latexcel@lastpaddingrow}{\latexcel@numrows+\latexcel@paddingrows}%
        \setint{\latexcel@firstpaddingcolumn}{\latexcel@numcolumns+1}%
        \setint{\latexcel@lastpaddingcolumn}{\latexcel@numcolumns+\latexcel@paddingcolumns}%
        \setint{\latexcel@columnlabelrow}{-\latexcel@paddingrows-1}%
        \setint{\latexcel@rowlabelcolumn}{-\latexcel@paddingcolumns-1}%
        \setint\latexcel@firstcolumnlabel{-\latexcel@paddingcolumns+1}%
        \setint\latexcel@firstrowlabel{-\latexcel@paddingrows+1}%
        %
        \scalebox{\fp_to_decimal:n \l_latexcel_scale_fp}{
            \begin{tikzpicture}[
                gridline/.style = {
                    draw = gridlinecolor,
                    line~width = 0.5pt
                },
                corner~border/.style = {
                    draw = cornerbordercolor,
                    line~width = 1mm
                },
                label~border/.style = {
                    draw = labelbordercolor,
                    % draw = red,
                    line~width = 0.75pt
                },
                border/.estyle = {
                    line~width = \l_latexcel_border_width_dim,
                    black,
                    \l_latexcel_border_style_tl
                }
            ]
                \createcoordinates
                \addlabels
                \addgridlines
                \bool_if:NTF \l_latexcel_border_bool {
                    \addborders
                    \bool_if:NTF \l_latexcel_row_borders_bool {
                        \addrowborders
                    } {}
                    \bool_if:NTF \l_latexcel_column_borders_bool {
                        \addcolumnborders
                    } {}
                }{}
                \colorcells
                \seq_pop_left:NN \l_latexcel_rows_seq \l_tmpa_tl
                \seq_set_split:NnV \l_latexcel_header_row_seq {&} {\l_tmpa_tl}
                % \latexcel_process_header_row:nn {\l_latexcel_header_cell_style_tl} {\l_tmpa_tl}
                \latexcel_process_header_row:n {\l_tmpa_tl}
                \seq_map_indexed_inline:Nn \l_latexcel_rows_seq {
                    % \latexcel_process_row:nnn {##1} {##2} {\l_latexcel_cell_style_tl}
                    \latexcel_process_row:nn {##1} {##2}
                }
                % if the selected cell tl is empty, then don't do anything
                \tl_if_empty:NTF \l_latexcel_selected_cell_tl {
                    % if show formula bar:
                    \bool_if:NTF \l_latexcel_show_formula_bar_bool {
                        \addformulabar{1}{1}{\l_latexcel_formula_tl}
                        \bool_if:NTF \l_latexcel_auto_formula_bool {
                            \addformula{\formula{\l_latexcel_formula_tl}}
                        } {
                            \addformula{\l_latexcel_formula_tl}
                        }
                    } {
                    }
                } {
                    \seq_set_split:NnV \l_tmpa_seq {,} {\l_latexcel_selected_cell_tl}
                    \setint{\selectedcellx}{\seq_item:Nn \l_tmpa_seq {1}}
                    \setint{\selectedcelly}{\seq_item:Nn \l_tmpa_seq {2}}
                    \selectedcell{\selectedcellx}{\selectedcelly}
                    % if show formula bar:
                    \bool_if:NTF \l_latexcel_show_formula_bar_bool {
                        \addformulabar{\selectedcellx}{\selectedcelly}{\l_latexcel_formula_tl}
                        \bool_if:NTF \l_latexcel_auto_formula_bool {
                            \addformula{\formula{\l_latexcel_formula_tl}}
                        } {
                            \addformula{\l_latexcel_formula_tl}
                        }
                    } {
                    }
                }
            \end{tikzpicture}
        }
    \group_end:
}

\seq_new:N \l_latexcel_header_row_out_seq
\seq_new:N \l_latexcel_row_out_seq

\cs_new_protected:Nn \latexcel_process_header_row:n {
    \seq_set_split:NnV \l_latexcel_cells_seq {&} {#1}
    \int_set:Nn \l_tmpa_int {\seq_count:N \l_latexcel_cells_seq}
    \seq_clear:N \l_latexcel_row_out_seq
    % map over the cells and the cell styles together, and add the style to the cell
    \seq_map_indexed_inline:Nn \l_latexcel_cells_seq {
        \tl_set:Nx \l_tmpa_tl {\seq_item:Nn \g_latexcel_header_styles_seq {##1}}
        \seq_put_right:No \l_latexcel_header_row_out_seq {\l_tmpa_tl {##2}}
    }

    \seq_set_map:NNn \l_latexcel_header_row_out_seq \l_latexcel_header_row_out_seq {
        \l_latexcel_every_header_cell_style_tl {##1}
    }

    \seq_map_indexed_inline:Nn \l_latexcel_header_row_out_seq {
        \cellcontents{##1}{1}{##2}
    }

}


\cs_new_protected:Nn \latexcel_process_row:nn {
    % #1 row number
    % #2 row contents

    \seq_set_split:Nnn \l_latexcel_cells_seq {&} {#2}
    \int_set:Nn \l_tmpa_int {\seq_count:N \l_latexcel_cells_seq}
    \seq_clear:N \l_latexcel_row_out_seq
    % map over the cells and the cell styles together, and add the style to the cell
    \seq_map_indexed_inline:Nn \l_latexcel_cells_seq {
        \tl_set:Nx \l_tmpa_tl {\seq_item:Nn \g_latexcel_cell_styles_seq {##1}}
        \seq_put_right:No \l_latexcel_row_out_seq {\l_tmpa_tl {##2}}
    }

    \seq_set_map:NNn \l_latexcel_row_out_seq \l_latexcel_row_out_seq {
        \l_latexcel_every_cell_style_tl {##1}
    }


    \seq_map_indexed_inline:Nn \l_latexcel_row_out_seq {
        \cellcontents{##1}{\fp_to_int:n{#1+1}}{##2}
    }
}

\ExplSyntaxOff

\newcommand\createcoordinates{
    \begin{scope}[yscale = -1]
        % main table ================================================================================================
        \foreach \x in {1,...,\latexcel@numcolumns} {
            \foreach \y in {1,...,\latexcel@numrows} {
                \coordinate (cell_\x_\y) at ({(\x-0.5)*\latexcel@cellwidth},{(\y-0.5)*\latexcel@cellheight});
            }
        }
        \foreach \x in {0, ..., \latexcel@numcolumns} {
            \foreach \y in {0, ..., \latexcel@numrows} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@cellwidth},{\y*\latexcel@cellheight});
            }
        }
        % main table ================================================================================================
        %
        % padding ===================================================================================================
        % padding rows and columns (extra rows and columns before and after the main table)
        \foreach \x in {-\latexcel@paddingcolumns,...,-1} {
            \foreach \y in {0,...,\latexcel@numrows} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@paddingcolumnwidth},{\y*\latexcel@cellheight});
            }
        }
        \foreach \x in {\latexcel@firstpaddingcolumn,...,\latexcel@lastpaddingcolumn} {
            \foreach \y in {0,...,\latexcel@numrows} {
                \coordinate (corner_\x_\y) at ({((\x-\latexcel@numcolumns)*\latexcel@paddingcolumnwidth + \latexcel@numcolumns * \latexcel@cellwidth)*1cm},{\y*\latexcel@cellheight});
            }
        }
        % padding columns
        \foreach \x in {0,...,\latexcel@numcolumns} {
            \foreach \y in {-\latexcel@paddingrows,...,-1} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@cellwidth},{\y*\latexcel@paddingrowheight});
            }
        }
        \foreach \x in {0,...,\latexcel@numcolumns} {
            \foreach \y in {\latexcel@firstpaddingrow,...,\latexcel@lastpaddingrow} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@cellwidth},{((\y-\latexcel@numrows)*\latexcel@paddingrowheight + \latexcel@numrows * \latexcel@cellheight)*1cm});
            }
        }
        % padding ===================================================================================================
        %
        % missing corners ===========================================================================================
        % top left
        \foreach \x in {-\latexcel@paddingcolumns,...,-1} {
            \foreach \y in {-\latexcel@paddingrows,...,-1} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@paddingcolumnwidth},{\y*\latexcel@paddingrowheight});
            }
        }
        % top right
        \foreach \x in {\latexcel@firstpaddingcolumn,...,\latexcel@lastpaddingcolumn} {
            \foreach \y in {-\latexcel@paddingrows,...,-1} {
                \coordinate (corner_\x_\y) at ({((\x-\latexcel@numcolumns)*\latexcel@paddingcolumnwidth + \latexcel@numcolumns * \latexcel@cellwidth)*1cm},{\y*\latexcel@paddingrowheight});
            }
        }
        % bottom left
        \foreach \x in {-\latexcel@paddingcolumns,...,-1} {
            \foreach \y in {\latexcel@firstpaddingrow,...,\latexcel@lastpaddingrow} {
                \coordinate (corner_\x_\y) at ({\x*\latexcel@paddingcolumnwidth},{((\y-\latexcel@numrows)*\latexcel@paddingrowheight + \latexcel@numrows * \latexcel@cellheight)*1cm});
            }
        }
        % bottom right
        \foreach \x in {\latexcel@firstpaddingcolumn,...,\latexcel@lastpaddingcolumn} {
            \foreach \y in {\latexcel@firstpaddingrow,...,\latexcel@lastpaddingrow} {
                \coordinate (corner_\x_\y) at ({((\x-\latexcel@numcolumns)*\latexcel@paddingcolumnwidth + \latexcel@numcolumns * \latexcel@cellwidth)*1cm},{((\y-\latexcel@numrows)*\latexcel@paddingrowheight + \latexcel@numrows * \latexcel@cellheight)*1cm});
            }
        }
        % missing corners ============================================================================================
        %
        % labels =====================================================================================================
        % Columns
        \foreach \x in {-\latexcel@paddingcolumns,...,-1} {
            \coordinate (corner_\x_\latexcel@columnlabelrow) at ({\x*\latexcel@paddingcolumnwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight});
        }
        \foreach \x in {0,..., \latexcel@numcolumns} {
            \coordinate (corner_\x_\latexcel@columnlabelrow) at ({\x*\latexcel@cellwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight});
        }
        \foreach \x in {\latexcel@firstpaddingcolumn,...,\latexcel@lastpaddingcolumn} {
            \coordinate (corner_\x_\latexcel@columnlabelrow) at ({((\x-\latexcel@numcolumns)*\latexcel@paddingcolumnwidth + \latexcel@numcolumns * \latexcel@cellwidth)*1cm},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight});
        }
        \foreach \x in {\latexcel@firstcolumnlabel,...,0} {
            \coordinate (cell_\x_\latexcel@columnlabelrow) at ({(\x-0.5)*\latexcel@paddingcolumnwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight/2});
        }
        \foreach \x in {1,..., \latexcel@numcolumns} {
            \coordinate (cell_\x_\latexcel@columnlabelrow) at ({(\x-0.5)*\latexcel@cellwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight/2});
        }
        \foreach \x in {\latexcel@firstpaddingcolumn,...,\latexcel@lastpaddingcolumn} {
            \coordinate (cell_\x_\latexcel@columnlabelrow) at ({((\x-\latexcel@numcolumns-0.5) * \latexcel@paddingcolumnwidth) + \latexcel@numcolumns * \latexcel@cellwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight/2});
        }
        % Rows
        \foreach \y in {-\latexcel@paddingrows,...,-1} {
            \coordinate (corner_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth},{\y*\latexcel@paddingrowheight});
        }
        \foreach \y in {0,..., \latexcel@numrows} {
            \coordinate (corner_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth},{\y*\latexcel@cellheight});
        }
        \foreach \y in {\latexcel@firstpaddingrow,...,\latexcel@lastpaddingrow} {
            \coordinate (corner_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth},{((\y-\latexcel@numrows)*\latexcel@paddingrowheight + \latexcel@numrows * \latexcel@cellheight)*1cm});
        }
        \foreach \y in {\latexcel@firstrowlabel,...,0} {
            \coordinate (cell_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth/2},{(\y-0.5)*\latexcel@paddingrowheight});
        }
        \foreach \y in {1,..., \latexcel@numrows} {
            \coordinate (cell_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth/2},{(\y-0.5)*\latexcel@cellheight});
        }
        \foreach \y in {\latexcel@firstpaddingrow,...,\latexcel@lastpaddingrow} {
            \coordinate (cell_\latexcel@rowlabelcolumn_\y) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth/2},{((\y-\latexcel@numrows-0.5) * \latexcel@paddingrowheight) + \latexcel@numrows * \latexcel@cellheight});
        }
        % Missing corner
        \coordinate (corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) at ({-\latexcel@paddingcolumns*\latexcel@paddingcolumnwidth - \latexcel@rowlabelwidth},{-\latexcel@paddingrows*\latexcel@paddingrowheight - \latexcel@columnlabelheight});
        % labels =====================================================================================================
    \end{scope} 
}

\newcommand{\addlabels}{
    \foreach \x in {\latexcel@firstcolumnlabel, ..., \latexcel@lastpaddingcolumn} {
        \cellcontents{\x}{\latexcel@columnlabelrow}{\footnotesize\color{labeltextcolor}\makeAlph{\x+\latexcel@startingcolumn-1}}
    }
    \foreach \y in {\latexcel@firstrowlabel, ..., \latexcel@lastpaddingrow} {
        \setint\rowlabel{\y+\latexcel@startingrow-1}
        \cellcontents{\latexcel@rowlabelcolumn}{\y}{\footnotesize\color{labeltextcolor}\rowlabel}
    }
}

\newcommand{\addgridlines}{
    \begin{pgfonlayer}{gridlines}
        \foreach \x in {-\latexcel@paddingcolumns,...,\latexcel@lastpaddingcolumn} {
            \draw[gridline] (corner_\x_-\latexcel@paddingrows) -- (corner_\x_\latexcel@lastpaddingrow);
        }
        \foreach \y in {-\latexcel@paddingrows,...,\latexcel@lastpaddingrow} {
            \draw[gridline] (corner_-\latexcel@paddingcolumns_\y) -- (corner_\latexcel@lastpaddingcolumn_\y);
        }
        \foreach \x in {-\latexcel@paddingcolumns,...,\latexcel@lastpaddingcolumn} {
            \draw[label border] (corner_\x_\latexcel@columnlabelrow) -- (corner_\x_-\latexcel@paddingrows);
        }
        \foreach \y in {-\latexcel@paddingrows,...,\latexcel@lastpaddingrow} {
            \draw[label border] (corner_\latexcel@rowlabelcolumn_\y) -- (corner_-\latexcel@paddingcolumns_\y);
        }
        \draw[label border] (corner_-\latexcel@paddingcolumns_\latexcel@columnlabelrow) -- (corner_\latexcel@lastpaddingcolumn_\latexcel@columnlabelrow);
        \draw[label border] (corner_\latexcel@rowlabelcolumn_-\latexcel@paddingrows) -- (corner_\latexcel@rowlabelcolumn_\latexcel@lastpaddingrow);
        \draw[label border] (corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) -- (corner_\latexcel@rowlabelcolumn_-\latexcel@paddingrows);
        \draw[label border] (corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) -- (corner_-\latexcel@paddingcolumns_\latexcel@columnlabelrow);
        \draw[label border] (corner_-\latexcel@paddingcolumns_\latexcel@columnlabelrow) -- (corner_-\latexcel@paddingcolumns_\latexcel@lastpaddingrow);
        \draw[label border] (corner_\latexcel@rowlabelcolumn_-\latexcel@paddingrows) -- (corner_\latexcel@lastpaddingcolumn_-\latexcel@paddingrows);
        \draw[corner border] (corner_-\latexcel@paddingcolumns_\latexcel@columnlabelrow) -- (corner_-\latexcel@paddingcolumns_-\latexcel@paddingrows) -- (corner_\latexcel@rowlabelcolumn_-\latexcel@paddingrows);
    \end{pgfonlayer}
}

\newcommand{\addborders}{
    \begin{pgfonlayer}{borders}
        \draw[border] (corner_0_0) rectangle (corner_\latexcel@numcolumns_\latexcel@numrows);
        % \foreach \x in {1,...,\latexcel@numcolumns} {
        %     \draw[border] (corner_\x_0) -- (corner_\x_\latexcel@numrows);
        % }
        \draw[border] (corner_0_1) -- (corner_\latexcel@numcolumns_1);
    \end{pgfonlayer}
}

\newcommand{\addrowborders}{
    \begin{pgfonlayer}{borders}
        \foreach \y in {1,...,\latexcel@numrows} {
            \draw[border] (corner_0_\y) -- (corner_\latexcel@numcolumns_\y);
        }
    \end{pgfonlayer}
}

\newcommand{\addcolumnborders}{
    \begin{pgfonlayer}{borders}
        \foreach \x in {1,...,\latexcel@numcolumns} {
            \draw[border] (corner_\x_0) -- (corner_\x_\latexcel@numrows);
        }
    \end{pgfonlayer}
}

\ExplSyntaxOn
\newcommand{\colorcells}{
    \begin{pgfonlayer}{cells}
        \foreach \x in {1,...,\latexcel@numcolumns} {
            \fillcell{\x}{1}{\tl_use:N \l_latexcel_header_row_color_tl}
        }
        \ifdim \latexcel@numrows pt < 2pt%
            % There is no even row to colour
        \else%
            \ifdim \latexcel@numrows pt < 4pt%
                % there is only one even row to colour. Do it manually
                \foreach \x in {1,...,\latexcel@numcolumns} {
                    \fillcell{\x}{2}{\tl_use:N \l_latexcel_even_row_color_tl}
                }
            \else%
                \foreach \y in {2,4,...,\latexcel@numrows} {
                    \foreach \x in {1,...,\latexcel@numcolumns} {
                        \fillcell{\x}{\y}{\tl_use:N \l_latexcel_even_row_color_tl}
                    }
                }
            \fi
        \fi
        \ifdim \latexcel@numrows pt < 3pt%
            % There is no odd row to colour
        \else%
            \ifdim \latexcel@numrows pt < 5pt%
                % there is only one odd row to colour. Do it manually
                \foreach \x in {1,...,\latexcel@numcolumns} {
                    \fillcell{\x}{3}{\tl_use:N \l_latexcel_odd_row_color_tl}
                }
            \else%
                \foreach \y in {3,5,...,\latexcel@numrows} {
                    \foreach \x in {1,...,\latexcel@numcolumns} {
                        \fillcell{\x}{\y}{\tl_use:N \l_latexcel_odd_row_color_tl}
                    }
                }
            \fi
        \fi
        \fillcell{-\latexcel@paddingcolumns}{-\latexcel@paddingrows}{gray!10!white}
    \end{pgfonlayer}
}


% \node[right, anchor = base west] at ($(formula divider) + (0.75, -0.5ex)$) {\texttt{=#3}};

% \tl_new:N \l_latexcel_cell_contents_temp_tl

\newcommand{\addformula}[1]{
    % if the formula is empty, do nothing
    \bool_if:NTF \l_latexcel_formula_is_blank_bool {
        % if there is a selected cell, get the cell contents and use that instead
        \tl_if_empty:NTF \l_latexcel_selected_cell_tl {
            % if there is no selected cell, do nothing
        } {
            \seq_set_split:NnV \l_tmpa_seq {,} {\l_latexcel_selected_cell_tl}
            \setint{\selectedcellx}{\seq_item:Nn \l_tmpa_seq {1}}
            \setint{\selectedcelly}{\seq_item:Nn \l_tmpa_seq {2}}
            \latexcel_get_cell_contents:nnn {\selectedcellx} {\selectedcelly} \l_tmpa_tl
            \node[right, anchor = base~west] at ($(formula~divider) + (0.75, -0.5ex)$) {\texttt{\l_tmpa_tl}};
        }
    }{
        \node[right, anchor = base~west] at ($(formula~divider) + (0.75, -0.5ex)$) {\texttt{=~#1}};
    }
}


\int_new:N \l_latexcel_get_cell_contents_x_int
\int_new:N \l_latexcel_get_cell_contents_y_int
\cs_new_protected:Nn \latexcel_get_cell_contents:nnn {
    % #1 - x
    % #2 - y
    % #3 - tl variable to store contents in
    \int_set:Nn \l_latexcel_get_cell_contents_x_int {#1}
    \int_set:Nn \l_latexcel_get_cell_contents_y_int {#2}
    % if the x or y component is less than 1, return an empty string
    \int_compare:nNnTF {\l_latexcel_get_cell_contents_x_int} < {1} {
        \tl_set:Nn #3 {}
    } {
        \int_compare:nNnTF {\l_latexcel_get_cell_contents_y_int} < {1} {
            \tl_set:Nn #3 {}
        } {
            % if the x or y component is greater than the number of columns or rows, return an empty string
            \int_compare:nNnTF {\l_latexcel_get_cell_contents_x_int} > {\latexcel@numcolumns} {
                \tl_set:Nn #3 {}
            } {
                \int_compare:nNnTF {\l_latexcel_get_cell_contents_y_int} > {\latexcel@numrows} {
                    \tl_set:Nn #3 {}
                } {
                    % otherwise, get the contents of the cell
                    % if y is 1, this is a header cell. Get the header row
                    \int_compare:nNnTF {\l_latexcel_get_cell_contents_y_int} = {1} {
                        \tl_set:Nx #3 {\seq_item:Nn \l_latexcel_header_row_seq {\l_latexcel_get_cell_contents_x_int}}
                    } {
                        % otherwise, get the row
                        % first, take 1 from y to account for the header row
                        \int_set:Nn \l_latexcel_get_cell_contents_y_int {\l_latexcel_get_cell_contents_y_int-1}
                        \tl_set:Nx #3 {\seq_item:cn {l_latexcel_rows_seq} {\l_latexcel_get_cell_contents_y_int}}
                        \seq_set_split:NnV \l_tmpa_seq {&} {#3}
                        \tl_set:Nx #3 {\seq_item:Nn \l_tmpa_seq {\l_latexcel_get_cell_contents_x_int}}
                    }
                }
            }
        }
    }
}


\cs_new_protected:Npn \seq_find:NnN #1#2#3
  {
    % #1 = sequence
    % #2 = item to find
    % #3 = int variable to store index

    % set the index to -1 to indicate not found
    \int_set:Nn #3 {-1}

    \seq_map_indexed_inline:Nn #1
      {
        \str_if_eq:nnT {##2} {#2}
          {
            \int_set:Nn #3 {##1}
            \seq_map_break:
          }
      }
  }

\cs_generate_variant:Nn \regex_split:nnN {nVN}
\cs_generate_variant:Nn \tl_replace_all:Nnn {NVn}

\seq_new:N \l_latexcel_colours_seq
\seq_set_from_clist:Nn \l_latexcel_colours_seq {Formula1, Formula2, Formula3, Formula4, Formula5, Formula6, Formula7, Formula8}

\int_new:N \l_latexcel_num_colours_int
\int_set:Nn \l_latexcel_num_colours_int { \seq_count:N \l_latexcel_colours_seq }


\tl_new:N \l_latexcel_formula_out_tl
% ---------------------------------------------

\seq_new:N \l_latexcel_formula_seq
\seq_new:N \l_latexcel_cell_addresses_seq

\cs_new_protected:Npn \latexcel_color_formula:n #1 {
    \tl_clear:N \l_latexcel_formula_out_tl
    \seq_clear:N \l_latexcel_cell_addresses_seq
    \str_set:Nx \l_tmpa_str {#1}


    % Applying colour to TRUE and FALSE. ------------------------------------------------
    % Without functioning lookahead and lookbehind, numbers can't be reliably matched.
    % color: FormulaNumber

    \regex_split:nVN {(TRUE|FALSE)} \l_tmpa_str \l_latexcel_formula_seq
    
    \seq_map_indexed_inline:Nn \l_latexcel_formula_seq
    {
        \int_compare:nNnTF { \int_mod:nn {##1} {2} } = {0}
        {
            \tl_put_right:Nn \l_latexcel_formula_out_tl {\textcolor{FormulaNumber}{##2}}
        }{
            \tl_put_right:Nn \l_latexcel_formula_out_tl {##2}
        }
    }

    % -------------------------------------------------------------------------------------------

    % Applying colour to strings. ------------------------------------------------
    % color: FormulaString
    % simple regex to match strings. Doesn't handle escaped quotes.

    \regex_split:nVN {("[^"]*?")} \l_latexcel_formula_out_tl \l_latexcel_formula_seq
    % \seq_show:N \l_latexcel_formula_seq
    \tl_clear:N \l_latexcel_formula_out_tl

    \seq_map_indexed_inline:Nn \l_latexcel_formula_seq
    {
        \int_compare:nNnTF { \int_mod:nn {##1} {2} } = {0}
        {
            \tl_put_right:Nn \l_latexcel_formula_out_tl {\textcolor{FormulaString}{##2}}
        }{
            \tl_put_right:Nn \l_latexcel_formula_out_tl {##2}
        }
    }

    % \tl_show:N \l_latexcel_formula_out_tl

    % -------------------------------------------------------------------------------------------

    % Applying colour to addresses in the formula. ---------------------------------------------
    \regex_split:nVN {((?:(?:[\w]*?!)|(?:'[\w\s]*?'!))?(?:(?:\$?[A-Z]+\$?[0-9]*:\$?[A-Z]+\$?[0-9]*)|(?:\$?[A-Z]+\$?[0-9]+)))} {\l_latexcel_formula_out_tl} \l_latexcel_formula_seq

    \tl_clear:N \l_latexcel_formula_out_tl

    % create a new sequence with every other item, skipping the first

    \seq_map_indexed_inline:Nn \l_latexcel_formula_seq
    {
        \int_compare:nNnT { \int_mod:nn {##1} {2} } = {0}
        {
            \seq_put_right:Nn \l_latexcel_cell_addresses_seq {##2}
        }
    }

    % remove duplicates

    \seq_remove_duplicates:N \l_latexcel_cell_addresses_seq

    
    \seq_map_indexed_inline:Nn \l_latexcel_formula_seq
    {
        \int_compare:nNnTF { \int_mod:nn {##1} {2} } = {0}
        {
            \seq_find:NnN \l_latexcel_cell_addresses_seq {##2} \l_tmpa_int
            \int_set:Nn \l_tmpa_int { \int_mod:nn { \l_tmpa_int - 1} { \l_latexcel_num_colours_int } + 1 }
            \tl_set:Nn \l_tmpa_tl { \seq_item:Nn \l_latexcel_colours_seq { \l_tmpa_int } }
            \tl_put_right:Nx \l_latexcel_formula_out_tl {\textcolor{\l_tmpa_tl}{##2}}
        }{
            \tl_put_right:Nn \l_latexcel_formula_out_tl {##2}
        }
    }
    % -------------------------------------------------------------------------------------------
    {\color{FormulaText}\tl_use:N \l_latexcel_formula_out_tl}
}

\newcommand{\formula}[1]{\latexcel_color_formula:n {#1}}


\ExplSyntaxOff

\newcommand{\selectedcell}[2]{
    \begin{pgfonlayer}{borders}
        \setint\selectedcellnextx{#1-1}
        \setint\selectedcellnexty{#2-1}
        \draw[selectedbordercolor, line width = 0.5mm] ($(corner_\selectedcellnextx_\selectedcellnexty)+(0.25mm, -0.25mm)$) rectangle ($(corner_#1_#2)+(-0.25mm, +0.25mm)$);
        \fill[selectedcelldotcolor, draw = white, thick] (corner_#1_#2) circle (1.25mm);
    \end{pgfonlayer}
    \begin{pgfonlayer}{cells}
        \fillcell{#1}{-\latexcel@paddingrows}{selectedcolumncolor}
        \fillcell{-\latexcel@paddingcolumns}{#2}{selectedcolumncolor}
    \end{pgfonlayer}
    \cellcontents{#1}{\latexcel@columnlabelrow}{\footnotesize\color{labeltextcolor}\bfseries\makeAlph{#1+\latexcel@startingcolumn-1}}
    \setint\rownumber{#2+\latexcel@startingrow-1}
    \cellcontents{\latexcel@rowlabelcolumn}{#2}{\footnotesize\color{labeltextcolor}\bfseries\rownumber}
}

\newcommand{\addformulabar}[3]{
    % #1 - selected cell x
    % #2 - selected cell y
    % #3 - formula
    \draw[formulabarbordercolor, line width = 1mm] ($(corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) + (0, \latexcel@formulabarheight * 1cm)$) -- ($(corner_\latexcel@lastpaddingcolumn_\latexcel@columnlabelrow) + (0, \latexcel@formulabarheight * 1cm)$);
    \setint\rownumber{#2+\latexcel@startingrow-1}
    \node[] at ($(corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow)!0.5!(corner_-\latexcel@paddingcolumns_\latexcel@columnlabelrow) + (0, \latexcel@formulabarheight/2 * 1cm)$) {\makeAlph{#1+\latexcel@startingcolumn-1}\rownumber};
    \draw[label border] ($(corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) + (\latexcel@selectedcellwidth, \latexcel@formulabarheight/2)$) coordinate (formula divider) ++ (0, 0.3*\latexcel@formulabarheight) -- ++ (0, -0.6 * \latexcel@formulabarheight);
    \fill[selectedcelldropdowncolor] ($(corner_\latexcel@rowlabelcolumn_\latexcel@columnlabelrow) + (\latexcel@selectedcellwidth, \latexcel@formulabarheight/2)$) ++ (-0.5, 0.5mm) -- ++ (1.1mm, 0) -- ++ (-1.1mm, -1.1mm) -- ++ (-1.1mm, 1.1mm) -- cycle;
    % got to fake bold for texttt
    \foreach \xshift in {-1, 0, 1} {
        \foreach \yshift in {-1, 0, 1} {
            \node[fxcolor] at ($(formula divider) + (0.5, 0) + (\xshift * 0.15pt, \yshift * 0.15pt)$) {\texttt{\textit{\fontfamily{cmr}\selectfont f}}\hspace{-0.5ex}\texttt{\fontfamily{cmr}\selectfont x}};
        }
    }
}

\definecolor{FormulaOrange}{HTML}{F7981E}
\definecolor{FormulaPurple}{HTML}{7E3794}
\definecolor{FormulaCyan}{HTML}{10A9CC}
\definecolor{FormulaMaroon}{HTML}{A61D4C}
\definecolor{FormulaBlue}{HTML}{4285F4}
\definecolor{FormulaYellow}{HTML}{F4B409}
\definecolor{FormulaGreen}{HTML}{65B045}
\definecolor{FormulaBrown}{HTML}{795548}

\colorlet{Formula1}{FormulaOrange}
\colorlet{Formula2}{FormulaPurple}
\colorlet{Formula3}{FormulaCyan}
\colorlet{Formula4}{FormulaMaroon}
\colorlet{Formula5}{FormulaBlue}
\colorlet{Formula6}{FormulaYellow}
\colorlet{Formula7}{FormulaGreen}
\colorlet{Formula8}{FormulaBrown}
%
\definecolor{FormulaNumber}{HTML}{1155CC}
\definecolor{FormulaString}{HTML}{008000}
\definecolor{FormulaText}{HTML}{1F1F1F}

\definecolor{SheetsGrey}{HTML}{CCCCCC}
\definecolor{SheetsDarkGrey1}{HTML}{B7B7B7}
\definecolor{SheetsDarkGrey2}{HTML}{999999}
\definecolor{SheetsDarkGrey3}{HTML}{666666}
\definecolor{SheetsDarkGrey4}{HTML}{434343}
\definecolor{SheetsLightGrey1}{HTML}{D9D9D9}
\definecolor{SheetsLightGrey2}{HTML}{EFEFEF}
\definecolor{SheetsLightGrey3}{HTML}{F3F3F3}
\definecolor{SheetsBerryRed}{HTML}{980000}
\definecolor{SheetsDarkBerryRed1}{HTML}{A61C00}
\definecolor{SheetsDarkBerryRed2}{HTML}{85200C}
\definecolor{SheetsDarkBerryRed3}{HTML}{5B0F00}
\definecolor{SheetsLightBerryRed1}{HTML}{CC4125}
\definecolor{SheetsLightBerryRed2}{HTML}{DD7E6B}
\definecolor{SheetsLightBerryRed3}{HTML}{E6B8AF}
\definecolor{SheetsRed}{HTML}{FF0000}
\definecolor{SheetsDarkRed1}{HTML}{CC0000}
\definecolor{SheetsDarkRed2}{HTML}{990000}
\definecolor{SheetsDarkRed3}{HTML}{660000}
\definecolor{SheetsLightRed1}{HTML}{E06666}
\definecolor{SheetsLightRed2}{HTML}{EA9999}
\definecolor{SheetsLightRed3}{HTML}{F4CCCC}
\definecolor{SheetsOrange}{HTML}{FF9900}
\definecolor{SheetsDarkOrange1}{HTML}{E69138}
\definecolor{SheetsDarkOrange2}{HTML}{B45F06}
\definecolor{SheetsDarkOrange3}{HTML}{783F04}
\definecolor{SheetsLightOrange1}{HTML}{F6B26B}
\definecolor{SheetsLightOrange2}{HTML}{F9CB9C}
\definecolor{SheetsLightOrange3}{HTML}{FCE5CD}
\definecolor{SheetsYellow}{HTML}{FFFF00}
\definecolor{SheetsDarkYellow1}{HTML}{F1C232}
\definecolor{SheetsDarkYellow2}{HTML}{BF9000}
\definecolor{SheetsDarkYellow3}{HTML}{7F6000}
\definecolor{SheetsLightYellow1}{HTML}{FFD966}
\definecolor{SheetsLightYellow2}{HTML}{FFE599}
\definecolor{SheetsLightYellow3}{HTML}{FFF2CC}
\definecolor{SheetsGreen}{HTML}{00FF00}
\definecolor{SheetsDarkGreen1}{HTML}{6AA84F}
\definecolor{SheetsDarkGreen2}{HTML}{38761D}
\definecolor{SheetsDarkGreen3}{HTML}{274E13}
\definecolor{SheetsLightGreen1}{HTML}{93C47D}
\definecolor{SheetsLightGreen2}{HTML}{B6D7A8}
\definecolor{SheetsLightGreen3}{HTML}{D9EAD3}
\definecolor{SheetsCyan}{HTML}{00FFFF}
\definecolor{SheetsDarkCyan1}{HTML}{45818E}
\definecolor{SheetsDarkCyan2}{HTML}{134F5C}
\definecolor{SheetsDarkCyan3}{HTML}{0C343D}
\definecolor{SheetsLightCyan1}{HTML}{76A5AF}
\definecolor{SheetsLightCyan2}{HTML}{A2C4C9}
\definecolor{SheetsLightCyan3}{HTML}{D0E0E3}
\definecolor{SheetsCornflowerBlue}{HTML}{4A86E8}
\definecolor{SheetsDarkCornflowerBlue1}{HTML}{3C78D8}
\definecolor{SheetsDarkCornflowerBlue2}{HTML}{1155CC}
\definecolor{SheetsDarkCornflowerBlue3}{HTML}{1C4587}
\definecolor{SheetsLightCornflowerBlue1}{HTML}{6D9EEB}
\definecolor{SheetsLightCornflowerBlue2}{HTML}{A4C2F4}
\definecolor{SheetsLightCornflowerBlue3}{HTML}{C9DAF8}
\definecolor{SheetsBlue}{HTML}{0000FF}
\definecolor{SheetsDarkBlue1}{HTML}{3D85C6}
\definecolor{SheetsDarkBlue2}{HTML}{0B5394}
\definecolor{SheetsDarkBlue3}{HTML}{073763}
\definecolor{SheetsLightBlue1}{HTML}{6FA8DC}
\definecolor{SheetsLightBlue2}{HTML}{9FC5E8}
\definecolor{SheetsLightBlue3}{HTML}{CFE2F3}
\definecolor{SheetsPurple}{HTML}{9900FF}
\definecolor{SheetsDarkPurple1}{HTML}{674EA7}
\definecolor{SheetsDarkPurple2}{HTML}{351C75}
\definecolor{SheetsDarkPurple3}{HTML}{20124D}
\definecolor{SheetsLightPurple1}{HTML}{8E7CC3}
\definecolor{SheetsLightPurple2}{HTML}{B4A7D6}
\definecolor{SheetsLightPurple3}{HTML}{D9D2E9}
\definecolor{SheetsMagenta}{HTML}{FF00FF}
\definecolor{SheetsDarkMagenta1}{HTML}{A64D79}
\definecolor{SheetsDarkMagenta2}{HTML}{741B47}
\definecolor{SheetsDarkMagenta3}{HTML}{4C1130}
\definecolor{SheetsLightMagenta1}{HTML}{C27BA0}
\definecolor{SheetsLightMagenta2}{HTML}{D5A6BD}
\definecolor{SheetsLightMagenta3}{HTML}{EAD1DC}
\definecolor{SheetsBlack}{HTML}{000000}
\definecolor{SheetsWhite}{HTML}{FFFFFF}